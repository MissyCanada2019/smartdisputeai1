<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDispute.ai - API Diagnostics</title>
    <style>
        :root {
            --primary-color: #c8102e;
            --dark-color: #212529;
            --light-color: #f8f9fa;
            --border-radius: 8px;
            --font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: #f5f5f5;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 16px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        h2 {
            color: var(--dark-color);
            margin: 20px 0 15px;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .status-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-name {
            font-weight: bold;
        }

        .status-value {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-neutral {
            background-color: #e2e3e5;
            color: #383d41;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin: 10px 0;
        }

        button:hover {
            opacity: 0.9;
        }

        .test-logs {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .test-log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .test-log-success {
            color: #155724;
        }

        .test-log-error {
            color: #721c24;
        }

        .test-log-info {
            color: #0c5460;
        }

        .system-info {
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SmartDispute.ai API Diagnostics</h1>

        <div class="status-section">
            <h2>Client API Status</h2>
            <div class="status-item">
                <span class="status-name">API Client</span>
                <span id="api-client-status" class="status-value status-neutral">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-name">Document Analyzer</span>
                <span id="document-analyzer-status" class="status-value status-neutral">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-name">Debug Utilities</span>
                <span id="debug-utilities-status" class="status-value status-neutral">Checking...</span>
            </div>
        </div>

        <div class="status-section">
            <h2>Connection Tests</h2>
            <div class="status-item">
                <span class="status-name">API Health Check</span>
                <span id="api-health-status" class="status-value status-neutral">Not Tested</span>
            </div>
            <div class="status-item">
                <span class="status-name">Document Upload API</span>
                <span id="doc-upload-status" class="status-value status-neutral">Not Tested</span>
            </div>
            <button id="run-tests">Run API Tests</button>
        </div>

        <div class="test-logs" id="test-logs">
            <div class="test-log-entry test-log-info">API diagnostics ready. Click "Run API Tests" to begin.</div>
        </div>

        <div class="system-info" id="system-info">
            <!-- System info will be populated here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiClientStatus = document.getElementById('api-client-status');
            const documentAnalyzerStatus = document.getElementById('document-analyzer-status');
            const debugUtilitiesStatus = document.getElementById('debug-utilities-status');
            const apiHealthStatus = document.getElementById('api-health-status');
            const docUploadStatus = document.getElementById('doc-upload-status');
            const runTestsButton = document.getElementById('run-tests');
            const testLogs = document.getElementById('test-logs');
            const systemInfo = document.getElementById('system-info');

            // Add a log entry to the test logs
            function addLog(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = `test-log-entry test-log-${type}`;
                logEntry.textContent = message;
                testLogs.appendChild(logEntry);
                testLogs.scrollTop = testLogs.scrollHeight;
            }

            // Update a status indicator
            function updateStatus(element, status, message = null) {
                element.className = `status-value status-${status}`;
                element.textContent = message || status;
            }

            // Check for the API client components
            function checkClientComponents() {
                addLog('Checking client components...');

                // Check Gx API client
                if (window.Gx) {
                    if (typeof window.Gx.apiRequest === 'function') {
                        updateStatus(apiClientStatus, 'success', 'Available');
                        addLog('✅ Gx API client is available and working correctly');
                    } else {
                        updateStatus(apiClientStatus, 'error', 'Missing apiRequest');
                        addLog('❌ Gx API client is available but missing apiRequest function', 'error');
                    }
                } else {
                    updateStatus(apiClientStatus, 'error', 'Not Available');
                    addLog('❌ Gx API client is not available', 'error');
                }

                // Check Document Analyzer
                if (window.MobileDocumentAnalyzer) {
                    if (typeof window.MobileDocumentAnalyzer.analyzeDocument === 'function') {
                        updateStatus(documentAnalyzerStatus, 'success', 'Available');
                        addLog('✅ Document Analyzer is available and working correctly');
                    } else {
                        updateStatus(documentAnalyzerStatus, 'error', 'Missing Methods');
                        addLog('❌ Document Analyzer is available but missing required methods', 'error');
                    }
                } else {
                    updateStatus(documentAnalyzerStatus, 'error', 'Not Available');
                    addLog('❌ Document Analyzer is not available', 'error');
                }

                // Check Debug Utilities
                if (window.SmartDisputeDebug) {
                    if (typeof window.SmartDisputeDebug.logApiClientInfo === 'function') {
                        updateStatus(debugUtilitiesStatus, 'success', 'Available');
                        addLog('✅ Debug utilities are available and working correctly');
                    } else {
                        updateStatus(debugUtilitiesStatus, 'error', 'Missing Methods');
                        addLog('❌ Debug utilities are available but missing required methods', 'error');
                    }
                } else {
                    updateStatus(debugUtilitiesStatus, 'error', 'Not Available');
                    addLog('❌ Debug utilities are not available', 'error');
                }
            }

            // Run API health check test
            async function testApiHealth() {
                addLog('Testing API health endpoint...');
                updateStatus(apiHealthStatus, 'neutral', 'Testing...');

                try {
                    let response;
                    if (window.Gx && typeof window.Gx.apiRequest === 'function') {
                        response = await window.Gx.apiRequest('/api/health');
                    } else {
                        response = await fetch('/api/health');
                    }

                    if (response.ok) {
                        updateStatus(apiHealthStatus, 'success', 'OK');
                        addLog(`✅ API health check successful (Status: ${response.status})`);
                    } else {
                        updateStatus(apiHealthStatus, 'error', `Error: ${response.status}`);
                        addLog(`❌ API health check failed (Status: ${response.status})`, 'error');
                    }
                } catch (error) {
                    updateStatus(apiHealthStatus, 'error', 'Connection Error');
                    addLog(`❌ API health check error: ${error.message}`, 'error');
                }
            }

            // Test document upload endpoint
            async function testDocumentUpload() {
                addLog('Testing document upload endpoint...');
                updateStatus(docUploadStatus, 'neutral', 'Testing...');

                try {
                    // Create a small test file
                    const testBlob = new Blob(['Test content for API diagnostics'], { type: 'text/plain' });
                    const testFile = new File([testBlob], 'test-file.txt', { type: 'text/plain' });

                    const formData = new FormData();
                    formData.append('document', testFile);
                    formData.append('province', 'ON');

                    let response;
                    if (window.Gx && typeof window.Gx.apiRequest === 'function') {
                        addLog('Using Gx.apiRequest for upload test');
                        response = await window.Gx.apiRequest('/api/test-upload', {
                            method: 'POST',
                            body: formData
                        });
                    } else {
                        addLog('Using fetch for upload test');
                        response = await fetch('/api/test-upload', {
                            method: 'POST',
                            body: formData
                        });
                    }

                    // Even if the endpoint doesn't exist, we're testing that the client can make the request
                    if (response.status === 404) {
                        updateStatus(docUploadStatus, 'success', 'Client OK (404 Expected)');
                        addLog('✅ Document upload client working (404 response is expected for test endpoint)');
                    } else if (response.ok) {
                        updateStatus(docUploadStatus, 'success', 'OK');
                        addLog(`✅ Document upload test successful (Status: ${response.status})`);
                    } else {
                        updateStatus(docUploadStatus, 'error', `Error: ${response.status}`);
                        addLog(`❌ Document upload test failed (Status: ${response.status})`, 'error');
                    }
                } catch (error) {
                    updateStatus(docUploadStatus, 'error', 'Connection Error');
                    addLog(`❌ Document upload test error: ${error.message}`, 'error');
                }
            }

            // Display system information
            function showSystemInfo() {
                const info = `
                    User Agent: ${navigator.userAgent}
                    Window Size: ${window.innerWidth}x${window.innerHeight}
                    Device Pixel Ratio: ${window.devicePixelRatio}
                    Platform: ${navigator.platform}
                `;
                systemInfo.textContent = info.trim();
            }

            // Run all tests
            async function runAllTests() {
                testLogs.innerHTML = ''; // Clear previous logs
                addLog('Starting API diagnostics tests...', 'info');
                
                runTestsButton.disabled = true;
                
                // Run all checks
                await checkClientComponents();
                await testApiHealth();
                await testDocumentUpload();
                
                addLog('All tests completed.', 'info');
                runTestsButton.disabled = false;
            }

            // Setup event listeners
            runTestsButton.addEventListener('click', runAllTests);

            // Initialize
            showSystemInfo();
            checkClientComponents();
        });
    </script>
</body>
</html>