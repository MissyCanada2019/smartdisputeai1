<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartDispute.ai - AI Service Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f8f9fa;
      color: #333;
    }
    h1, h2 {
      color: #2c3e50;
      border-bottom: 2px solid #e74c3c;
      padding-bottom: 10px;
    }
    .status-container {
      background-color: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .service-status {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .status-available {
      background-color: #2ecc71;
    }
    .status-unavailable {
      background-color: #e74c3c;
    }
    .text-area-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    textarea {
      flex: 1;
      min-height: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      resize: vertical;
      background-color: #fff;
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .info-panel {
      padding: 15px;
      background-color: #d6eaf8;
      border-left: 4px solid #3498db;
      margin-bottom: 20px;
      border-radius: 0 4px 4px 0;
    }
    .error-panel {
      padding: 15px;
      background-color: #fadbd8;
      border-left: 4px solid #e74c3c;
      margin-bottom: 20px;
      border-radius: 0 4px 4px 0;
      display: none;
    }
    .result-container {
      background-color: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border-left-color: #3498db;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      display: inline-block;
    }
    .loading-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .merit-container {
      margin-bottom: 20px;
    }
    .merit-bar {
      height: 20px;
      background-color: #ecf0f1;
      border-radius: 10px;
      margin-top: 10px;
      overflow: hidden;
      position: relative;
    }
    .merit-value {
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
      transition: width 0.5s ease-in-out;
    }
    .merit-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #333;
      font-weight: bold;
      text-shadow: 0 0 2px white;
    }
    .key-points {
      margin-top: 15px;
    }
    .key-points ul {
      list-style-type: none;
      padding-left: 0;
    }
    .key-points li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .key-points li:before {
      content: "â€¢";
      color: #3498db;
      font-weight: bold;
      display: inline-block;
      width: 1em;
      margin-left: -1em;
    }
    .response-html {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      background-color: #fff;
    }
  </style>
</head>
<body>
  <h1>SmartDispute.ai - AI Service Test</h1>
  
  <div class="info-panel">
    <p>This test page allows you to verify the functionality of the SmartDispute.ai unified AI service. It supports multiple AI providers with automatic fallback.</p>
  </div>
  
  <div class="error-panel" id="error-panel">
    <p id="error-message"></p>
  </div>
  
  <h2>Service Status</h2>
  <div class="status-container">
    <div class="service-status">
      <div class="status-dot" id="anthropic-status-dot"></div>
      <span>Anthropic Claude: <span id="anthropic-status">Checking...</span></span>
    </div>
    <div class="service-status">
      <div class="status-dot" id="openai-status-dot"></div>
      <span>OpenAI GPT-4o: <span id="openai-status">Checking...</span></span>
    </div>
    <div class="service-status">
      <div class="status-dot" id="mock-status-dot"></div>
      <span>Mock Mode: <span id="mock-status">Checking...</span></span>
    </div>
    <div class="service-status">
      <span>Default Provider: <span id="default-provider">Checking...</span></span>
    </div>
  </div>
  
  <h2>Document Analysis Test</h2>
  <div class="text-area-container">
    <textarea id="input-text" placeholder="Paste your document text here...">NOTICE OF EVICTION

Date: April 1, 2025
Property Address: 123 Main Street, Unit 4B
Tenant Name: John Smith

Dear Mr. Smith,

This letter serves as a formal notice that you are being evicted from the above-referenced premises due to non-payment of rent. According to our records, you have failed to pay rent in the amount of $1,200 for the month of March 2025.

As per the terms of your lease agreement and in accordance with the Residential Tenancies Act, you are hereby given 14 days' notice to vacate the premises. If you fail to vacate by April 15, 2025, we will commence legal proceedings for possession of the property and recovery of all unpaid rent, late fees, and legal costs.

You may prevent this eviction by paying the full amount owed ($1,200) plus the applicable late fee ($50) within 7 days of receipt of this notice.

If you have any questions regarding this notice, please contact our office at (555) 123-4567.

Sincerely,
Jane Doe
Property Manager
ABC Property Management</textarea>
    <div id="analysis-result" class="hidden">
      <div class="merit-container">
        <h3>Document Strength Rating</h3>
        <p id="merit-description"></p>
        <div class="merit-bar">
          <div class="merit-value" id="merit-value"></div>
          <span class="merit-label" id="merit-label"></span>
        </div>
      </div>
      
      <div>
        <h3>Document Analysis</h3>
        <p><strong>Document Type:</strong> <span id="document-type"></span></p>
        <p><strong>Issue Type:</strong> <span id="issue-type"></span></p>
        <p><strong>Relevant Law:</strong> <span id="relevant-law"></span></p>
        <p><strong>Urgency Level:</strong> <span id="urgency-level"></span></p>
        <p><strong>Confidence Score:</strong> <span id="confidence-score"></span></p>
      </div>
      
      <div class="key-points">
        <h3>Key Points</h3>
        <ul id="key-points-list"></ul>
      </div>
      
      <div>
        <h3>Recommended Next Steps</h3>
        <ul id="next-steps-list"></ul>
      </div>
    </div>
  </div>
  
  <div class="buttons">
    <button id="analyze-btn">Analyze Document</button>
    <button id="generate-response-btn" disabled>Generate Response</button>
    <button id="chat-btn">Ask AI Assistant</button>
    <button id="reset-btn">Reset</button>
  </div>
  
  <div class="loading-bar" id="loading-bar">
    <div class="spinner"></div>
    <span>Processing...</span>
  </div>
  
  <div id="response-container" class="result-container hidden">
    <h2>Generated Response</h2>
    <div id="response-html" class="response-html"></div>
  </div>
  
  <div id="chat-container" class="result-container hidden">
    <h2>AI Assistant Chat</h2>
    <div>
      <textarea id="chat-input" placeholder="Ask a question about tenant rights, eviction notices, or legal advice..."></textarea>
      <button id="send-chat-btn">Send</button>
    </div>
    <div id="chat-result" class="response-html"></div>
  </div>
  
  <script>
    // Elements
    const inputText = document.getElementById('input-text');
    const analyzeBtn = document.getElementById('analyze-btn');
    const generateResponseBtn = document.getElementById('generate-response-btn');
    const chatBtn = document.getElementById('chat-btn');
    const resetBtn = document.getElementById('reset-btn');
    const loadingBar = document.getElementById('loading-bar');
    const analysisResult = document.getElementById('analysis-result');
    const responseContainer = document.getElementById('response-container');
    const responseHtml = document.getElementById('response-html');
    const chatContainer = document.getElementById('chat-container');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    const chatResult = document.getElementById('chat-result');
    const errorPanel = document.getElementById('error-panel');
    const errorMessage = document.getElementById('error-message');
    
    // Status indicators
    const anthropicStatusDot = document.getElementById('anthropic-status-dot');
    const openaiStatusDot = document.getElementById('openai-status-dot');
    const mockStatusDot = document.getElementById('mock-status-dot');
    const anthropicStatus = document.getElementById('anthropic-status');
    const openaiStatus = document.getElementById('openai-status');
    const mockStatus = document.getElementById('mock-status');
    const defaultProvider = document.getElementById('default-provider');
    
    // Analysis result elements
    const documentType = document.getElementById('document-type');
    const issueType = document.getElementById('issue-type');
    const relevantLaw = document.getElementById('relevant-law');
    const urgencyLevel = document.getElementById('urgency-level');
    const confidenceScore = document.getElementById('confidence-score');
    const keyPointsList = document.getElementById('key-points-list');
    const nextStepsList = document.getElementById('next-steps-list');
    const meritDescription = document.getElementById('merit-description');
    const meritValue = document.getElementById('merit-value');
    const meritLabel = document.getElementById('merit-label');
    
    // Current analysis result
    let currentAnalysis = null;
    
    // Check service status on page load
    window.addEventListener('DOMContentLoaded', checkServiceStatus);
    
    // Event listeners
    analyzeBtn.addEventListener('click', analyzeDocument);
    generateResponseBtn.addEventListener('click', generateResponse);
    chatBtn.addEventListener('click', toggleChat);
    resetBtn.addEventListener('click', resetAll);
    sendChatBtn.addEventListener('click', sendChatMessage);
    
    async function checkServiceStatus() {
      try {
        const response = await fetch('/api/ai/status');
        const data = await response.json();
        
        updateStatusIndicator(anthropicStatusDot, anthropicStatus, data.anthropic.available);
        updateStatusIndicator(openaiStatusDot, openaiStatus, data.openai.available);
        updateStatusIndicator(mockStatusDot, mockStatus, data.mockMode);
        
        defaultProvider.textContent = data.defaultProvider || 'None';
        
        if (!data.anthropic.available && !data.openai.available && !data.mockMode) {
          showError('No AI services are available. Please configure API keys or enable mock mode.');
        }
      } catch (error) {
        console.error('Error checking service status:', error);
        showError('Could not connect to the AI service. Please check your internet connection or server status.');
      }
    }
    
    function updateStatusIndicator(dot, text, isAvailable) {
      if (isAvailable) {
        dot.className = 'status-dot status-available';
        text.textContent = 'Available';
      } else {
        dot.className = 'status-dot status-unavailable';
        text.textContent = 'Unavailable';
      }
    }
    
    async function analyzeDocument() {
      if (!inputText.value.trim()) {
        showError('Please enter document text to analyze.');
        return;
      }
      
      showLoading(true);
      hideError();
      
      try {
        const response = await fetch('/api/ai/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: inputText.value,
            province: 'ON' // Default to Ontario
          }),
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const result = await response.json();
        currentAnalysis = result;
        displayAnalysisResult(result);
        generateResponseBtn.disabled = false;
      } catch (error) {
        console.error('Error analyzing document:', error);
        showError(`Failed to analyze document: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    function displayAnalysisResult(result) {
      // Set text values
      documentType.textContent = result.documentType || 'Unknown';
      issueType.textContent = result.issueType || 'Unknown';
      relevantLaw.textContent = result.relevantLaw || 'Not specified';
      urgencyLevel.textContent = result.urgencyLevel || 'Medium';
      confidenceScore.textContent = result.confidenceScore ? (result.confidenceScore * 100).toFixed(1) + '%' : 'N/A';
      
      // Calculate merit weight
      const meritWeight = result.meritWeight !== undefined ? result.meritWeight : calculateMeritWeight(result);
      
      // Update merit bar
      updateMeritBar(meritWeight);
      
      // Populate key points
      keyPointsList.innerHTML = '';
      if (result.keyPoints && result.keyPoints.length > 0) {
        result.keyPoints.forEach(point => {
          const li = document.createElement('li');
          li.textContent = point;
          keyPointsList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No key points identified.';
        keyPointsList.appendChild(li);
      }
      
      // Populate next steps
      nextStepsList.innerHTML = '';
      if (result.nextSteps && result.nextSteps.length > 0) {
        result.nextSteps.forEach(step => {
          const li = document.createElement('li');
          li.textContent = step;
          nextStepsList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No specific next steps recommended.';
        nextStepsList.appendChild(li);
      }
      
      // Show the analysis result
      analysisResult.classList.remove('hidden');
      responseContainer.classList.add('hidden');
      chatContainer.classList.add('hidden');
    }
    
    function calculateMeritWeight(analysis) {
      if (analysis.meritWeight !== undefined) {
        return analysis.meritWeight;
      }
      
      // Fallback calculation
      let weight = 0.5; // Default moderate
      
      if (analysis.confidenceScore !== undefined) {
        weight = Math.min(0.95, Math.max(0.05, analysis.confidenceScore));
      } else if (analysis.urgencyLevel) {
        // Adjust based on urgency
        if (analysis.urgencyLevel.toLowerCase() === 'critical') weight = 0.85;
        else if (analysis.urgencyLevel.toLowerCase() === 'high') weight = 0.7;
        else if (analysis.urgencyLevel.toLowerCase() === 'medium') weight = 0.5;
        else if (analysis.urgencyLevel.toLowerCase() === 'low') weight = 0.3;
      }
      
      return weight;
    }
    
    function updateMeritBar(weight) {
      const percentage = Math.min(100, Math.max(0, weight * 100));
      meritValue.style.width = `${percentage}%`;
      
      // Get the merit rating based on weight
      let rating = 'Moderate';
      let color = '#f39c12';
      
      if (weight >= 0.8) {
        rating = 'Very Strong';
        color = '#27ae60';
      } else if (weight >= 0.6) {
        rating = 'Strong';
        color = '#2ecc71';
      } else if (weight >= 0.4) {
        rating = 'Moderate';
        color = '#f39c12';
      } else if (weight >= 0.2) {
        rating = 'Weak';
        color = '#e67e22';
      } else {
        rating = 'Very Weak';
        color = '#e74c3c';
      }
      
      meritLabel.textContent = `${Math.round(percentage)}% - ${rating}`;
      meritDescription.textContent = `This document has a ${rating.toLowerCase()} strength rating, which indicates your position in a potential dispute.`;
      meritValue.style.background = color;
    }
    
    async function generateResponse() {
      if (!currentAnalysis) {
        showError('Please analyze a document first.');
        return;
      }
      
      showLoading(true);
      hideError();
      
      try {
        const response = await fetch('/api/ai/generate-response', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            analysis: currentAnalysis,
            originalText: inputText.value,
            userInfo: {
              name: 'John Doe',
              address: '123 Main Street, Toronto, ON',
              email: 'john.doe@example.com',
              phone: '(555) 123-4567'
            }
          }),
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const result = await response.text();
        responseHtml.innerHTML = result;
        responseContainer.classList.remove('hidden');
        analysisResult.classList.remove('hidden');
        chatContainer.classList.add('hidden');
      } catch (error) {
        console.error('Error generating response:', error);
        showError(`Failed to generate response: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    function toggleChat() {
      chatContainer.classList.toggle('hidden');
      if (!chatContainer.classList.contains('hidden')) {
        chatInput.focus();
        responseContainer.classList.add('hidden');
      }
    }
    
    async function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message) {
        return;
      }
      
      showLoading(true);
      hideError();
      
      try {
        const response = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message }),
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const result = await response.text();
        chatResult.innerHTML = `<p><strong>You:</strong> ${message}</p><p><strong>AI:</strong> ${result}</p>`;
        chatInput.value = '';
      } catch (error) {
        console.error('Error sending chat message:', error);
        showError(`Failed to send message: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    function resetAll() {
      currentAnalysis = null;
      inputText.value = '';
      analysisResult.classList.add('hidden');
      responseContainer.classList.add('hidden');
      chatContainer.classList.add('hidden');
      generateResponseBtn.disabled = true;
      hideError();
    }
    
    function showLoading(isLoading) {
      loadingBar.style.display = isLoading ? 'flex' : 'none';
      analyzeBtn.disabled = isLoading;
      generateResponseBtn.disabled = isLoading || !currentAnalysis;
      chatBtn.disabled = isLoading;
      resetBtn.disabled = isLoading;
      sendChatBtn.disabled = isLoading;
    }
    
    function showError(message) {
      errorPanel.style.display = 'block';
      errorMessage.textContent = message;
    }
    
    function hideError() {
      errorPanel.style.display = 'none';
    }
  </script>
</body>
</html>